# Role
당신은 **Senior Full-Stack Engineer (Spring Boot + React)**입니다.
현재 운영 중인 다마고치 웹 서비스에서 발생하는 **심각한 성능 저하**와 **데이터 충돌 오류(409 Conflict)**를 해결해야 합니다.

# 🚨 Critical Issues (Evidence Based)

**1. 409 Conflict (Data Consistency Issue)**
- **증상:** 프론트엔드에서 `/api/pet/affection-complete` 및 `/api/pet/save-gauges` 요청 시 `409 Conflict` 에러가 빈번하게 발생합니다.
- **원인:**
    1. 사용자의 버튼 연타(Rapid Clicks)로 인해 프론트엔드가 이전 버전의 데이터를 기반으로 요청을 보냅니다.
    2. 백엔드에서 `JPA Optimistic Locking`(@Version) 충돌이 발생하거나, 동시에 수정 요청이 들어와 트랜잭션이 실패합니다.

**2. N+1 Query Problem (Performance Bottleneck)**
- **증상:** 첨부한 로그를 보면, 다이어리 목록을 조회할 때 `select count(likes)`와 `select count(comments)` 쿼리가 게시글 수만큼 반복해서 실행되고 있습니다.
- **영향:** 이로 인해 DB 커넥션 점유 시간이 길어지고, 이는 1번 문제(409 Conflict)의 발생 확률을 높이는 원인이 됩니다.

**3. State Reset Bug (Data Persistence)**
- **증상:** 페이지를 새로고침하면 경험치나 게이지가 DB값(예: 80%)이 아닌 초기값(50%)으로 리셋되는 현상이 있습니다.

---

# 🛠️ Action Plan

### Task 1. Backend Performance Tuning (Spring Boot)
**목표:** N+1 문제를 해결하고, 동시성 처리를 강화하세요.

1.  **DiaryRepository 최적화:**
    - `findAll` 또는 목록 조회 시 `JOIN FETCH` 또는 `@EntityGraph`를 사용하여 댓글/좋아요 개수를 한 번의 쿼리(또는 BatchSize)로 가져오게 수정하세요.
    - 또는 `count` 서브쿼리를 포함한 DTO 조회 방식으로 변경하여 N+1을 제거하세요.

2.  **Atomic Update 도입 (409 해결):**
    - `PetStatus`의 게이지(affection, hunger 등)를 수정할 때, 객체를 가져와서 setter로 수정하는 방식(`read-modify-write`)을 버리세요.
    - 대신, **JPQL 직접 업데이트 쿼리**(`UPDATE PetStatus p SET p.affection = p.affection + :amount`)를 사용하여 DB 레벨에서 락 없이 원자적으로 처리되게 만드세요. (`@Modifying` 사용)
    - 또는 서비스 계층에 `@Retryable`을 적용하여 낙관적 락 충돌 시 자동으로 재시도하게 하세요.

### Task 2. Frontend Logic Improvement (React)
**목표:** 불필요한 요청을 줄이고 데이터 정합성을 맞추세요.

1.  **Debounce (디바운스) 적용:**
    - '쓰다듬기', '환기' 등의 버튼 클릭 시 API를 즉시 호출하지 말고, **lodash.debounce** 또는 커스텀 훅을 사용하여 마지막 클릭 후 0.5~1초 뒤에 한 번만 서버로 요청을 보내게 수정하세요.

2.  **Optimistic UI & Error Handling:**
    - 화면의 게이지는 즉시 올라가게 하되(UX 향상), 만약 409 에러가 발생하면 조용히 무시하지 말고 `fetchPetStatus()`를 호출하여 최신 서버 데이터로 강제 동기화하세요.

3.  **Initialization Fix:**
    - `useEffect` (Mount 시점)에서 백엔드 데이터를 가져오기 전까지는 로딩 스피너를 보여주거나, 초기값을 `null`로 설정하여 '50%로 깜빡이는' 현상을 막으세요.

# 📂 Reference Logs (For Context)
(아래 로그는 참고용입니다)
- Backend: `Hibernate: select count(l1_0.id)...` (Repeated 20+ times)
- Frontend: `POST .../affection-complete 409 (Conflict)`
- Frontend: `[PetContext] affectionComplete 실패: AxiosError`

# 🎯 Deliverables
위의 문제들을 해결한 **수정된 Backend Repository/Service 코드**와 **Frontend Context/API 코드**를 제공하세요.