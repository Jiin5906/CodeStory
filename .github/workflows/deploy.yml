name: Deploy to EC2 with Docker Compose

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      # 1. í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ (Node.js ì„¤ì • ë° ë¹Œë“œ)
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build Frontend
        env:
          VITE_GTM_ID: ${{ secrets.VITE_GTM_ID }}
        run: |
          cd frontend/CodeStory/codestory-chatbot
          npm install
          npm run build

      # 2. ë¹Œë“œëœ í”„ë¡ íŠ¸ì—”ë“œ íŒŒì¼ì„ ë°±ì—”ë“œ static í´ë”ë¡œ ë³µì‚¬ (ë§¤ìš° ì¤‘ìš”)
      - name: Copy Frontend Build to Spring Boot
        run: |
          mkdir -p diary/src/main/resources/static
          cp -r frontend/CodeStory/codestory-chatbot/dist/* diary/src/main/resources/static/

      # 3. Java ë¹Œë“œ (í”„ë¡ íŠ¸ íŒŒì¼ì´ í¬í•¨ëœ ìƒíƒœë¡œ íŒ¨í‚¤ì§•)
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Build with Gradle
        run: |
          cd diary
          chmod +x gradlew
          ./gradlew clean bootJar -x test

      # 4. ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ & í‘¸ì‹œ
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/diary-backend:latest

      # 5. EC2 ì ‘ì† ë° ë°°í¬
      - name: Deploy to EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            cd CodeStory
            git pull origin main
            
            # .env íŒŒì¼ ìƒì„±
            echo "DB_ROOT_PASSWORD=${{ secrets.DB_PASSWORD }}" > .env
            echo "DB_NAME=codestory_db" >> .env
            echo "DB_USER=${{ secrets.DB_USER }}" >> .env
            echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env
            echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> .env
            echo "GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}" >> .env
            echo "GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}" >> .env
            echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
            echo "PINECONE_API_KEY=${{ secrets.PINECONE_API_KEY }}" >> .env
            echo "PINECONE_ENVIRONMENT=${{ secrets.PINECONE_ENVIRONMENT }}" >> .env
            echo "PINECONE_INDEX_NAME=${{ secrets.PINECONE_INDEX_NAME }}" >> .env
            echo "NEO4J_URI=${{ secrets.NEO4J_URI }}" >> .env
            echo "NEO4J_USERNAME=${{ secrets.NEO4J_USERNAME }}" >> .env
            echo "NEO4J_PASSWORD=${{ secrets.NEO4J_PASSWORD }}" >> .env
            echo "DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}" >> .env
            
            docker-compose pull backend
            docker-compose up -d backend
            docker image prune -f
            echo "ğŸš€ ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"